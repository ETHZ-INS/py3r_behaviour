name: Release

on:
  push:
    branches: [ main ]

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate version bump against latest tag
        shell: bash
        run: |
          set -euo pipefail
          git fetch --tags --quiet
          LATEST_TAG=$(git tag -l 'v*' --sort=-v:refname | head -n1)
          if [ -z "$LATEST_TAG" ]; then LATEST_TAG="v0.0.0"; fi
          echo "Latest tag: $LATEST_TAG"
          PYVER=$(python -c 'from pathlib import Path; import tomllib; print(tomllib.loads(Path("pyproject.toml").read_text())["project"]["version"])')
          echo "pyproject version: $PYVER"
          export LATEST_TAG PYVER
          python -c 'import os, re, sys; \
            def parse(v): \
                m = re.match(r"^(\d+)\.(\d+)\.(\d+)$", v); \
                if not m: raise SystemExit(f"Invalid semver: {v}"); \
                return tuple(map(int, m.groups())); \
            latest = os.environ.get("LATEST_TAG","v0.0.0").lstrip("v"); \
            newver = os.environ["PYVER"]; \
            la, lb, lc = parse(latest); \
            na, nb, nc = parse(newver); \
            allowed = {(la, lb, lc+1), (la, lb+1, 0), (la+1, 0, 0)}; \
            if (na, nb, nc) not in allowed: \
                sys.exit(f"pyproject version {newver} must be one of: {la}.{lb}.{lc+1} (patch) or {la}.{lb+1}.0 (minor) or {la+1}.0.0 (major); latest tag is v{latest}"); \
            print("Version bump check passed.")'

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          python -m pip install -U pip
          pip install -e .[dev] \
            'mkdocstrings[python]' mkdocs-material mike mkdocs-autorefs \
            xdoctest pytest toml

      - name: Generate batch mixins
        run: python -m tools.gen_batch_mixins

      - name: Enforce generated files committed
        run: |
          git diff --exit-code || (echo "Uncommitted changes after generation. Commit mixins." && exit 1)

      - name: Run tests
        run: pytest -q --xdoctest --xdoctest-modules

      - name: Read version from pyproject
        id: readver
        shell: python
        run: |
          from pathlib import Path
          import tomllib, os
          v = tomllib.loads(Path("pyproject.toml").read_text())["project"]["version"]
          with open(os.environ["GITHUB_OUTPUT"], "a") as f:
              f.write(f"version={v}\n")

      - name: Ensure tag does not already exist
        run: |
          git fetch --tags --quiet
          TAG="v${{ steps.readver.outputs.version }}"
          if git rev-parse -q --verify "refs/tags/$TAG" >/dev/null; then
            echo "Tag $TAG already exists"; exit 1
          fi

      - name: Create tag
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@users.noreply.github.com"
          TAG="v${{ steps.readver.outputs.version }}"
          git tag -a "$TAG" -m "$TAG"
          git push origin "$TAG"

      - name: Create draft GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.readver.outputs.version }}
          name: v${{ steps.readver.outputs.version }}
          draft: true
          generate_release_notes: true

      - name: Build docs (validate only)
        run: mkdocs build --strict


