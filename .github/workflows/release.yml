name: Release

on:
  push:
    branches: [ main ]

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate version bump against latest tag
        shell: bash
        run: |
          set -euo pipefail
          git fetch --tags --quiet
          LATEST_TAG=$(git tag -l 'v*' --sort=-v:refname | head -n1)
          if [ -z "$LATEST_TAG" ]; then LATEST_TAG="v0.0.0"; fi
          echo "Latest tag: $LATEST_TAG"
          PYVER=$(python -c 'from pathlib import Path; import tomllib; print(tomllib.loads(Path("pyproject.toml").read_text())["project"]["version"])')
          echo "pyproject version: $PYVER"
          export LATEST_TAG PYVER
          python -c 'import os,re,sys; latest=os.environ.get("LATEST_TAG","v0.0.0").lstrip("v"); newver=os.environ["PYVER"]; rx=re.compile(r"^(\d+)\.(\d+)\.(\d+)$"); m1=rx.match(latest); m2=rx.match(newver); \
            (sys.exit(f"Invalid semver(s): latest={latest}, new={newver}")) if not (m1 and m2) else None; \
            la,lb,lc=map(int,m1.groups()); na,nb,nc=map(int,m2.groups()); allowed={(la,lb,lc+1),(la,lb+1,0),(la+1,0,0)}; \
            (sys.exit(f"pyproject version {newver} must be one of: {la}.{lb}.{lc+1} (patch) or {la}.{lb+1}.0 (minor) or {la+1}.0.0 (major); latest tag is v{latest}")) if (na,nb,nc) not in allowed else print("Version bump check passed.")'

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          python -m pip install -U pip
          pip install -e .[dev] \
            'mkdocstrings[python]' mkdocs-material mike mkdocs-autorefs \
            xdoctest pytest toml

      - name: Generate batch mixins
        run: python -m tools.gen_batch_mixins

      - name: Enforce generated files committed
        run: |
          git diff --exit-code || (echo "Uncommitted changes after generation. Commit mixins." && exit 1)

      - name: Run tests
        run: pytest -q --xdoctest --xdoctest-modules

      - name: Read version from pyproject
        id: readver
        shell: python
        run: |
          from pathlib import Path
          import tomllib, os
          v = tomllib.loads(Path("pyproject.toml").read_text())["project"]["version"]
          with open(os.environ["GITHUB_OUTPUT"], "a") as f:
              f.write(f"version={v}\n")

      - name: Ensure tag does not already exist
        run: |
          git fetch --tags --quiet
          TAG="v${{ steps.readver.outputs.version }}"
          if git rev-parse -q --verify "refs/tags/$TAG" >/dev/null; then
            echo "Tag $TAG already exists"; exit 1
          fi

      - name: Create and push tag
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@users.noreply.github.com"
          TAG="v${{ steps.readver.outputs.version }}"
          git tag -a "$TAG" -m "$TAG"
          git push origin "$TAG"

      - name: Update draft release with tag (Release Drafter)
        uses: release-drafter/release-drafter@v6
        with:
          config-name: release-drafter.yml
          tag: v${{ steps.readver.outputs.version }}
          name: v${{ steps.readver.outputs.version }}
          version: ${{ steps.readver.outputs.version }}
          commitish: main
          publish: false

      - name: Build docs (validate only)
        run: mkdocs build --strict


