name: CI

on:
  pull_request:
  push:

jobs:
  test-and-docs:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate version bump for main (PRs and pushes)
        if: (github.event_name == 'pull_request' && github.base_ref == 'main') || (github.event_name == 'push' && github.ref == 'refs/heads/main')
        shell: bash
        run: |
          set -euo pipefail
          git fetch --tags --quiet
          LATEST_TAG=$(git tag -l 'v*' --sort=-v:refname | head -n1)
          if [ -z "$LATEST_TAG" ]; then LATEST_TAG="v0.0.0"; fi
          echo "Latest tag: $LATEST_TAG"
          PYVER=$(python - <<'PY'
            from pathlib import Path
            import tomllib
            print(tomllib.loads(Path("pyproject.toml").read_text())["project"]["version"])
            PY
          )
          echo "pyproject version: $PYVER"
          export LATEST_TAG PYVER
          python - <<'PY'
            import os, re, sys
            def parse(v):
                m = re.match(r'^(\d+)\.(\d+)\.(\d+)$', v)
                if not m: raise SystemExit(f"Invalid semver: {v}")
                return tuple(map(int, m.groups()))
            latest = os.environ.get("LATEST_TAG","v0.0.0").lstrip("v")
            newver = os.environ["PYVER"]
            la, lb, lc = parse(latest)
            na, nb, nc = parse(newver)
            allowed = {(la, lb, lc+1), (la, lb+1, 0), (la+1, 0, 0)}
            if (na, nb, nc) not in allowed:
                sys.exit(f"pyproject version {newver} must be one of: "
                         f"{la}.{lb}.{lc+1} (patch) or {la}.{lb+1}.0 (minor) or {la+1}.0.0 (major); latest tag is v{latest}")
            print("Version bump check passed.")
            PY

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: pip-${{ runner.os }}-${{ hashFiles('**/pyproject.toml') }}

      - name: Install dependencies
        run: |
          python -m pip install -U pip
          pip install -e .[dev] \
            'mkdocstrings[python]' mkdocs-material mike mkdocs-autorefs \
            xdoctest pytest

      - name: Generate batch mixins
        run: python -m tools.gen_batch_mixins

      - name: Enforce generated files committed
        run: |
          git diff --exit-code || (echo "Uncommitted changes after generation. Commit mixins." && exit 1)

      - name: Run tests (incl. doctests)
        run: pytest -q --xdoctest --xdoctest-modules

      - name: Build docs
        run: mkdocs build --strict

      - name: Upload docs artifact on PRs
        if: github.event_name == 'pull_request'
        uses: actions/upload-artifact@v4
        with:
          name: site
          path: site


